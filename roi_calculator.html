<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate ROI & CLP Simulator (Advanced)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .input-group-title {
            border-bottom: 2px solid #6366f1; /* Indigo-500 */
            padding-bottom: 8px;
            font-weight: 700;
            color: #1e3a8a; /* Blue-900 */
        }
        .result-card {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 240px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -120px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        input:read-only {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-700">Real Estate ROI Simulator</h1>
            <p class="mt-2 text-lg text-gray-600">Make informed investment decisions with detailed cash flow and return analysis.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Inputs Section -->
            <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-gray-700">Investment Inputs</h2>
                
                <!-- Group A: Project Details -->
                <div class="mb-6">
                    <h3 class="input-group-title mb-4">A: Project & Purchase Details</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="propertyStatus" class="block text-sm font-medium text-gray-700">Property Status</label>
                            <select id="propertyStatus" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="Under-Construction">Under-Construction</option>
                                <option value="Ready-to-Move">Ready-to-Move</option>
                            </select>
                        </div>
                        <div>
                            <label for="state" class="block text-sm font-medium text-gray-700">State</label>
                            <select id="state" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="Maharashtra">Maharashtra</option>
                                <option value="Karnataka">Karnataka</option>
                                <option value="Delhi">Delhi</option>
                                <option value="Haryana">Haryana</option>
                                <option value="Telangana">Telangana</option>
                            </select>
                        </div>
                        <div>
                            <label for="propertyArea" class="block text-sm font-medium text-gray-700">Property Area (sq. ft.)</label>
                            <input type="number" id="propertyArea" value="1000" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="bsp" class="block text-sm font-medium text-gray-700">Basic Sale Price (₹ per sq. ft.)</label>
                            <input type="number" id="bsp" value="10000" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="otherCharges" class="block text-sm font-medium text-gray-700">Other Developer Charges (₹)</label>
                            <input type="number" id="otherCharges" value="500000" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                </div>

                <!-- Group B: Financing & Tax -->
                <div class="mb-6">
                    <h3 class="input-group-title mb-4">B: Financing & Tax</h3>
                    <div class="space-y-4">
                         <div>
                            <label for="downPayment" class="block text-sm font-medium text-gray-700">Down Payment (%)</label>
                            <input type="number" id="downPayment" value="20" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="interestRate" class="block text-sm font-medium text-gray-700">Home Loan Interest Rate (%)</label>
                            <input type="number" id="interestRate" value="8.5" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="loanTenure" class="block text-sm font-medium text-gray-700">Loan Tenure (Years)</label>
                            <input type="number" id="loanTenure" value="20" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="taxSlab" class="block text-sm font-medium text-gray-700">Your Income Tax Slab (%)</label>
                            <select id="taxSlab" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="0.30">30%</option>
                                <option value="0.20">20%</option>
                                <option value="0.10">10%</option>
                                <option value="0.05">5%</option>
                                <option value="0">0% / No Tax</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Group C: Construction & Post-Possession -->
                <div class="mb-6">
                    <h3 class="input-group-title mb-4">C: Timeline & Ongoing Costs</h3>
                    <div id="clpSection" class="space-y-4">
                        <div>
                            <label for="constructionPeriod" class="block text-sm font-medium text-gray-700">Construction Period (Months)</label>
                            <input type="number" id="constructionPeriod" value="36" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Disbursement Schedule</label>
                            <textarea id="disbursementSchedule" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" rows="4">3, 10
9, 15
18, 20
36, 55</textarea>
                            <p class="text-xs text-gray-500 mt-1">Format: month, cumulative_percentage (e.g., 3, 10). Each on a new line.</p>
                        </div>
                    </div>
                     <div class="space-y-4 mt-4">
                        <div>
                            <label for="registryYear" class="block text-sm font-medium text-gray-700">Registry will be done in Year #</label>
                            <input type="number" id="registryYear" value="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="willRent" class="block text-sm font-medium text-gray-700">Will property be rented out?</label>
                             <select id="willRent" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                         <div id="rentInputs" class="space-y-4 p-4 bg-gray-50 rounded-md border">
                             <div>
                                <label for="rentStartYear" class="block text-sm font-medium text-gray-700">Rent can start from Year #</label>
                                <input type="number" id="rentStartYear" value="4" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                             </div>
                             <div>
                                <label for="fitOutCost" class="block text-sm font-medium text-gray-700">One-time Fit-Out Cost (₹)</label>
                                <input type="number" id="fitOutCost" value="200000" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                             </div>
                             <div>
                                <label for="monthlyRent" class="block text-sm font-medium text-gray-700">Initial Monthly Rent (₹)</label>
                                <input type="number" id="monthlyRent" value="35000" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                             </div>
                             <div>
                                <label for="rentIncrease" class="block text-sm font-medium text-gray-700">Annual Rent Increase (%)</label>
                                <input type="number" id="rentIncrease" value="5" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                             </div>
                         </div>
                         <div class="space-y-4 mt-4 p-4 bg-gray-50 rounded-md border">
                            <label class="block text-sm font-bold text-gray-800">Maintenance & Property Tax</label>
                            <div>
                               <label for="advanceMaintenance" class="block text-sm font-medium text-gray-700">Advance Maintenance paid on Possession (Months)</label>
                               <input type="number" id="advanceMaintenance" value="12" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                               <label for="monthlyMaintenance" class="block text-sm font-medium text-gray-700">Recurring Monthly Maintenance (₹)</label>
                               <input type="number" id="monthlyMaintenance" value="5000" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="propertyTax" class="block text-sm font-medium text-gray-700">Annual Property Tax (% of Property Cost)</label>
                                <input type="number" id="propertyTax" value="0.2" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                         </div>
                    </div>
                </div>

                <!-- Group D: Exit Scenarios -->
                <div class="mb-6">
                    <h3 class="input-group-title mb-4">D: Investment Exit Scenarios</h3>
                     <div class="space-y-4">
                         <div id="exitScenariosContainer" class="space-y-2">
                             <!-- Scenarios will be added here -->
                         </div>
                         <button id="addScenario" class="mt-2 text-sm text-indigo-600 hover:text-indigo-800 font-medium">+ Add Scenario</button>
                    </div>
                </div>

                <button id="calculateBtn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300">
                    Calculate ROI
                </button>
            </div>

            <!-- Results Section -->
            <div class="lg:col-span-2">
                 <div id="resultsDashboard" class="bg-white p-6 rounded-xl shadow-lg min-h-full" style="display: none;">
                    <h2 class="text-3xl font-bold mb-6 text-gray-800 border-b pb-4">Investment Dashboard</h2>
                    
                    <div id="loader" class="flex justify-center items-center py-16" style="display: none;"><div class="loader"></div></div>
                    
                    <div id="resultsContent">
                        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 mb-8" id="scenarioResults"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Cost & Loan Summary</h3>
                                <div id="costBreakdown" class="space-y-2 text-sm"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h3 class="text-xl font-semibold mb-3 text-gray-700">Key Metrics</h3>
                                <div id="loanSummary" class="space-y-2 text-sm"></div>
                            </div>
                        </div>

                        <div class="mt-8">
                             <h3 class="text-xl font-semibold mb-3 text-gray-700">Year-on-Year Cash Flow for 
                                <select id="scenarioSelector" class="ml-2 p-1 text-sm border border-gray-300 rounded-md"></select>
                             </h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-100">
                                        <tr>
                                            <th class="px-2 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Year</th>
                                            <th class="px-2 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Inflows</th>
                                            <th class="px-2 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Outflows</th>
                                            <th class="px-2 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Net Flow</th>
                                        </tr>
                                    </thead>
                                    <tbody id="cashFlowTable" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                 </div>
                 <div id="welcomeMessage" class="flex items-center justify-center bg-white p-6 rounded-xl shadow-lg min-h-full">
                     <div class="text-center">
                         <svg class="mx-auto h-12 w-12 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                         </svg>
                         <h3 class="mt-2 text-xl font-medium text-gray-900">Ready to Analyze?</h3>
                         <p class="mt-1 text-gray-500">Enter your investment details on the left and click "Calculate ROI" to see your personalized dashboard.</p>
                     </div>
                 </div>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- DATA & CONFIG ---
    const stampDutyData = {
        'Maharashtra': { 'duty': 0.06, 'reg': 0.01 },
        'Karnataka': { 'duty': 0.056, 'reg': 0.01 },
        'Delhi': { 'duty': 0.06, 'reg': 0.01 },
        'Haryana': { 'duty': 0.07, 'reg': 0.01 },
        'Telangana': { 'duty': 0.04, 'reg': 0.005 },
    };

    // --- DOM ELEMENT REFERENCES ---
    const elements = {
        propertyStatus: document.getElementById('propertyStatus'),
        clpSection: document.getElementById('clpSection'),
        willRent: document.getElementById('willRent'),
        rentInputs: document.getElementById('rentInputs'),
        scenariosContainer: document.getElementById('exitScenariosContainer'),
        addScenarioBtn: document.getElementById('addScenario'),
        calculateBtn: document.getElementById('calculateBtn'),
        welcomeMessage: document.getElementById('welcomeMessage'),
        resultsDashboard: document.getElementById('resultsDashboard'),
        loader: document.getElementById('loader'),
        resultsContent: document.getElementById('resultsContent'),
        scenarioResults: document.getElementById('scenarioResults'),
        costBreakdown: document.getElementById('costBreakdown'),
        loanSummary: document.getElementById('loanSummary'),
        scenarioSelector: document.getElementById('scenarioSelector'),
        cashFlowTable: document.getElementById('cashFlowTable'),
        propertyArea: document.getElementById('propertyArea')
    };
    
    // --- UI EVENT LISTENERS ---
    elements.propertyStatus.addEventListener('change', toggleClpSection);
    elements.willRent.addEventListener('change', toggleRentInputs);
    elements.addScenarioBtn.addEventListener('click', () => addScenarioRow());
    elements.calculateBtn.addEventListener('click', runSimulation);

    // --- INITIALIZATION ---
    addScenarioRow(7, 15000);
    addScenarioRow(12, 22000);
    toggleClpSection();
    toggleRentInputs();

    // --- UI HELPER FUNCTIONS ---
    function toggleClpSection() {
        elements.clpSection.style.display = elements.propertyStatus.value === 'Under-Construction' ? 'block' : 'none';
    }

    function toggleRentInputs() {
        elements.rentInputs.style.display = elements.willRent.value === 'yes' ? 'block' : 'none';
    }

    function addScenarioRow(duration = 10, salePricePerSqFt = 20000) {
        const div = document.createElement('div');
        div.className = 'flex items-center space-x-2';
        div.innerHTML = `
            <input type="number" title="Holding Duration (Years)" placeholder="Duration (Yrs)" value="${duration}" class="w-1/3 p-2 border border-gray-300 rounded-md shadow-sm">
            <input type="number" title="Sale Price (₹ per sq. ft.)" placeholder="Sale Price (₹/sq.ft)" value="${salePricePerSqFt}" class="w-2/3 p-2 border border-gray-300 rounded-md shadow-sm">
            <button class="removeScenario text-red-500 hover:text-red-700 font-bold">&times;</button>
        `;
        elements.scenariosContainer.appendChild(div);
        div.querySelector('.removeScenario').addEventListener('click', (e) => {
            if (elements.scenariosContainer.children.length > 1) e.target.parentElement.remove();
        });
    }

    // --- INPUT GATHERING ---
    function getInputs() {
        const getVal = (id, isFloat = true) => (isFloat ? parseFloat : parseInt)(document.getElementById(id).value);
        return {
            status: document.getElementById('propertyStatus').value,
            state: document.getElementById('state').value,
            area: getVal('propertyArea'),
            bsp: getVal('bsp'),
            otherCharges: getVal('otherCharges'),
            downPaymentPerc: getVal('downPayment') / 100,
            interestRate: getVal('interestRate') / 100,
            loanTenure: getVal('loanTenure', false),
            taxSlab: getVal('taxSlab'),
            constructionPeriod: getVal('constructionPeriod', false),
            disbursementSchedule: document.getElementById('disbursementSchedule').value.trim().split('\n').map(line => {
                const [month, perc] = line.split(',');
                return { month: parseInt(month.trim()), perc: parseFloat(perc.trim()) / 100 };
            }),
            registryYear: getVal('registryYear', false),
            willRent: document.getElementById('willRent').value === 'yes',
            rentStartYear: getVal('rentStartYear', false),
            fitOutCost: getVal('fitOutCost'),
            monthlyRent: getVal('monthlyRent'),
            rentIncrease: getVal('rentIncrease') / 100,
            advanceMaintenance: getVal('advanceMaintenance', false),
            monthlyMaintenance: getVal('monthlyMaintenance'),
            propertyTaxPerc: getVal('propertyTax') / 100,
            scenarios: Array.from(elements.scenariosContainer.children).map(div => ({
                duration: parseInt(div.children[0].value),
                salePricePerSqFt: parseFloat(div.children[1].value)
            })),
        };
    }

    // --- MAIN SIMULATION LOGIC ---
    function runSimulation() {
        elements.welcomeMessage.style.display = 'none';
        elements.resultsDashboard.style.display = 'block';
        elements.resultsContent.style.display = 'none';
        elements.loader.style.display = 'flex';
        
        setTimeout(() => {
            const inputs = getInputs();
            const results = calculateAllScenarios(inputs);
            displayResults(results, inputs);
            elements.loader.style.display = 'none';
            elements.resultsContent.style.display = 'block';
        }, 500);
    }

    // --- CORE CALCULATION ENGINE ---
    function calculatePMT(rate, nper, pv) {
        if (rate === 0) return -pv / nper;
        return rate * pv / (1 - Math.pow(1 + rate, -nper));
    }

    function calculateIRR(cashFlows, guess = 0.1) {
        const maxIterations = 50, tolerance = 1e-7;
        for (let i = 0; i < maxIterations; i++) {
            let npv = 0, dnpv = 0;
            for (let t = 0; t < cashFlows.length; t++) {
                npv += cashFlows[t] / Math.pow(1 + guess, t);
                dnpv -= t * cashFlows[t] / Math.pow(1 + guess, t + 1);
            }
            if (dnpv === 0) return NaN;
            const newGuess = guess - npv / dnpv;
            if (Math.abs(newGuess - guess) < tolerance) return newGuess;
            guess = newGuess;
        }
        return NaN;
    }

    function calculateAllScenarios(inputs) {
        const { state, area, bsp, otherCharges, downPaymentPerc, interestRate, loanTenure } = inputs;

        const propertyCost = (area * bsp) + otherCharges;
        const stampDutyRate = stampDutyData[state]?.duty || 0.06;
        const regFeeRate = stampDutyData[state]?.reg || 0.01;
        const stampDuty = propertyCost * stampDutyRate;
        const regFee = propertyCost * regFeeRate;

        const initialInvestment = propertyCost * downPaymentPerc;
        const loanAmount = propertyCost - initialInvestment;

        const monthlyInterestRate = interestRate / 12;
        const loanTenureMonths = loanTenure * 12;
        const fullEMI = calculatePMT(monthlyInterestRate, loanTenureMonths, loanAmount);

        let scenarioResults = [];
        let totalPreEMIPaid = 0;

        for (const scenario of inputs.scenarios) {
            const investmentHorizon = scenario.duration;
            let cashFlows = [-initialInvestment];
            let yearlyCashFlows = [];
            let loanBalance = loanAmount;
            
            const constructionMonths = inputs.status === 'Under-Construction' ? inputs.constructionPeriod : 0;
            const possessionYear = Math.ceil(constructionMonths / 12);
            let cumulativePreEmiInterest = 0;
            let disbursedAmount = 0;
            let lastDisbursedPerc = 0;

            for (let year = 1; year <= investmentHorizon; year++) {
                let yearlyInflows = { rent: 0, taxSavings: 0, sale: 0 };
                let yearlyOutflows = { emi: 0, preEmi: 0, maintenance: 0, propertyTax: 0, fitOut: 0, registry: 0 };
                let yearlyInterestPaid = 0, yearlyPrincipalPaid = 0;

                // Pre-EMI Period
                if (year <= possessionYear && inputs.status === 'Under-Construction') {
                    const startMonth = (year - 1) * 12 + 1;
                    const endMonth = year * 12;
                    let interestForYear = 0;
                    for (let month = startMonth; month <= endMonth && month <= constructionMonths; month++) {
                        const currentDisbursementPerc = inputs.disbursementSchedule.reduce((acc, dis) => (month >= dis.month ? dis.perc : acc), 0);
                        if(currentDisbursementPerc > lastDisbursedPerc){
                            disbursedAmount = loanAmount * currentDisbursementPerc;
                            lastDisbursedPerc = currentDisbursementPerc;
                        }
                        interestForYear += disbursedAmount * monthlyInterestRate;
                    }
                    yearlyOutflows.preEmi = interestForYear;
                    yearlyInterestPaid = interestForYear;
                    cumulativePreEmiInterest += interestForYear;
                } else { // Full EMI Period
                    for (let m = 0; m < 12; m++) {
                        if ((year - 1) * 12 + m < loanTenureMonths + constructionMonths) {
                             const interestPayment = loanBalance * monthlyInterestRate;
                             const principalPayment = fullEMI - interestPayment;
                             yearlyInterestPaid += interestPayment;
                             yearlyPrincipalPaid += principalPayment;
                             loanBalance -= principalPayment;
                        }
                    }
                    yearlyOutflows.emi = yearlyInterestPaid + yearlyPrincipalPaid;
                }

                // Rent, Maintenance, Tax, Fit-out, Registry
                if (year >= inputs.rentStartYear && inputs.willRent) {
                    yearlyInflows.rent = inputs.monthlyRent * 12 * Math.pow(1 + inputs.rentIncrease, year - inputs.rentStartYear);
                }
                if (year === inputs.rentStartYear && inputs.willRent) yearlyOutflows.fitOut = inputs.fitOutCost;
                
                if (year > possessionYear) {
                    yearlyOutflows.maintenance = inputs.monthlyMaintenance * 12;
                    if(year === possessionYear + 1) yearlyOutflows.maintenance += inputs.advanceMaintenance * inputs.monthlyMaintenance;

                    yearlyOutflows.propertyTax = propertyCost * inputs.propertyTaxPerc;
                }

                if (year === inputs.registryYear) yearlyOutflows.registry = stampDuty + regFee;
                
                // Tax Savings Calculation (Disabled as per user request)
                yearlyInflows.taxSavings = 0;

                // Sale in the final year
                if (year === investmentHorizon) {
                    yearlyInflows.sale = (scenario.salePricePerSqFt * area) - loanBalance;
                }
                
                const totalIn = Object.values(yearlyInflows).reduce((a, b) => a + b, 0);
                const totalOut = Object.values(yearlyOutflows).reduce((a, b) => a + b, 0);
                const netCashFlowForYear = totalIn - totalOut;

                cashFlows.push(netCashFlowForYear);
                yearlyCashFlows.push({ year, inflows: yearlyInflows, outflows: yearlyOutflows, net: netCashFlowForYear });
            }
            
            totalPreEMIPaid = cumulativePreEmiInterest;
            const irr = calculateIRR(cashFlows) || 0;
            const netProfit = cashFlows.reduce((a, b) => a + b, 0);
            const cagr = Math.pow((initialInvestment + netProfit) / initialInvestment, 1 / investmentHorizon) - 1;

            scenarioResults.push({ ...scenario, irr: irr * 100, netProfit, cagr: cagr * 100, yearlyCashFlows });
        }
        
        return {
            costs: { propertyCost, stampDuty, regFee, initialInvestment, loanAmount, totalPreEMIPaid },
            loan: { fullEMI },
            scenarios: scenarioResults
        };
    }

    // --- DISPLAY RESULTS ---
    function displayResults(results, inputs) {
        elements.scenarioResults.innerHTML = '';
        elements.scenarioSelector.innerHTML = '';

        results.scenarios.forEach((s, index) => {
            const card = document.createElement('div');
            card.className = 'result-card bg-indigo-50 p-5 rounded-lg text-center border-l-4 border-indigo-500';
            card.innerHTML = `
                <h4 class="font-semibold text-lg text-indigo-800">Sell after ${s.duration} Yrs</h4>
                <p class="text-3xl font-bold text-indigo-600 my-2">${s.irr.toFixed(2)}%</p>
                <p class="text-sm text-gray-600 font-medium">IRR</p>
                <hr class="my-3">
                <div class="text-left text-sm space-y-1">
                    <p><strong>Net Profit:</strong> ₹${s.netProfit.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>
                    <p><strong>CAGR:</strong> ${s.cagr.toFixed(2)}%</p>
                </div>
            `;
            elements.scenarioResults.appendChild(card);

            const option = document.createElement('option');
            option.value = index;
            option.textContent = `Scenario: ${s.duration} Years`;
            elements.scenarioSelector.appendChild(option);
        });

        const { costs, loan } = results;
        elements.costBreakdown.innerHTML = `
            <p><strong>Property Cost:</strong> ₹${costs.propertyCost.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>
            <p><strong>Your Initial Investment:</strong> ₹${costs.initialInvestment.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>
            <p><strong>Loan Amount:</strong> ₹${costs.loanAmount.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>
            <p class="text-gray-600"><strong>Govt. Charges (in Yr ${inputs.registryYear}):</strong> ₹${(costs.stampDuty + costs.regFee).toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>
        `;

        elements.loanSummary.innerHTML = `
            <p><strong>Monthly EMI (Full):</strong> ₹${loan.fullEMI.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>
            ${costs.totalPreEMIPaid > 0 ? `<p class="text-red-600"><strong>Total Pre-EMI Paid:</strong> ₹${costs.totalPreEMIPaid.toLocaleString('en-IN', { maximumFractionDigits: 0 })}</p>` : ''}
        `;
        
        displayCashFlow(results.scenarios[0].yearlyCashFlows);
        elements.scenarioSelector.onchange = (e) => displayCashFlow(results.scenarios[e.target.value].yearlyCashFlows);
    }
    
    function displayCashFlow(yearlyCashFlows) {
        elements.cashFlowTable.innerHTML = '';
        const format = (val) => `₹${val.toLocaleString('en-IN', { maximumFractionDigits: 0 })}`;

        yearlyCashFlows.forEach(cf => {
            const row = document.createElement('tr');
            const totalIn = Object.values(cf.inflows).reduce((a,b) => a+b, 0);
            const totalOut = Object.values(cf.outflows).reduce((a,b) => a+b, 0);
            row.className = cf.net >= 0 ? 'bg-green-50' : 'bg-red-50';
            row.innerHTML = `
                <td class="px-2 py-2 whitespace-nowrap text-sm font-medium">Year ${cf.year}</td>
                <td class="px-2 py-2 whitespace-nowrap text-sm text-green-700">${format(totalIn)}</td>
                <td class="px-2 py-2 whitespace-nowrap text-sm text-red-700">${format(totalOut)}</td>
                <td class="px-2 py-2 whitespace-nowrap text-sm font-bold ${cf.net >= 0 ? 'text-green-800' : 'text-red-800'}">${format(cf.net)}</td>
            `;
            elements.cashFlowTable.appendChild(row);
        });
    }
});
</script>

</body>
</html>

